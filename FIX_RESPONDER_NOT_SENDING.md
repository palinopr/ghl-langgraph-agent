# Fix: Responder Not Sending Messages

## Problem
All 3 traces show:
```
ðŸ“¤ RESPONDER NODE:
  - Message sent: No
  - Status: 
```

Messages are being generated by agents but NOT sent back to customers!

## Root Cause Analysis

Looking at the responder node, there are several possible causes:

1. **Missing GHL API credentials**
2. **Responder checking for wrong message format**
3. **Error in send_message but not logged**
4. **Message filtering too aggressive**

## Investigation Steps

### 1. Check Responder Logic
```python
# app/agents/responder_agent.py

# Current logic might be:
if not any(msg for msg in messages if should_send(msg)):
    return {"response_sent": False}

# The should_send() function might be filtering out valid messages
```

### 2. Common Issues

#### A. Message Type Filtering
```python
# WRONG - Too restrictive
if msg.type == "ai" and msg.name == "sofia":
    send_message(msg)

# CORRECT - Send any agent message
if msg.type == "ai" and msg.name in ["maria", "carlos", "sofia"]:
    send_message(msg)
```

#### B. Empty State Issue
```python
# WRONG
messages = state.get("messages", [])
if not messages:
    return {"response_sent": False}

# CORRECT - Check for agent messages specifically
agent_messages = [
    msg for msg in state.get("messages", [])
    if hasattr(msg, "type") and msg.type == "ai"
    and hasattr(msg, "name") and msg.name in ["maria", "carlos", "sofia"]
]
```

## Quick Fix

```python
# app/agents/responder_agent.py

async def responder_node(state: Dict[str, Any]) -> Dict[str, Any]:
    """Send the agent's response back to GHL"""
    logger.info("Responder node processing")
    
    try:
        contact_id = state.get("contact_id")
        if not contact_id:
            logger.error("No contact_id in state")
            return {"response_sent": False, "responder_status": "no_contact_id"}
        
        messages = state.get("messages", [])
        
        # Find the LAST agent message (not system messages)
        agent_message = None
        for msg in reversed(messages):
            if hasattr(msg, "type") and msg.type == "ai":
                # Check if it's from an agent (not system)
                if hasattr(msg, "name") and msg.name in ["maria", "carlos", "sofia"]:
                    agent_message = msg
                    break
        
        if not agent_message:
            logger.warning("No agent message found to send")
            return {"response_sent": False, "responder_status": "no_agent_message"}
        
        # Send the message
        ghl_client = GHLClient()
        
        # Extract content
        content = agent_message.content
        if not content:
            logger.warning("Agent message has no content")
            return {"response_sent": False, "responder_status": "empty_content"}
        
        # Log what we're sending
        logger.info(f"Sending message to {contact_id}: {content[:50]}...")
        
        # Send via GHL
        result = await ghl_client.send_message(
            contact_id=contact_id,
            message=content,
            type="SMS"  # or get from webhook_data
        )
        
        if result:
            logger.info("âœ… Message sent successfully")
            return {
                "response_sent": True, 
                "responder_status": "sent",
                "messages": state["messages"]  # Keep state intact
            }
        else:
            logger.error("Failed to send message via GHL")
            return {"response_sent": False, "responder_status": "ghl_error"}
            
    except Exception as e:
        logger.error(f"Responder error: {e}", exc_info=True)
        return {
            "response_sent": False, 
            "responder_status": f"error: {str(e)}"
        }
```

## Alternative Issues

### 1. Workflow Not Reaching Responder
Check if the workflow is actually calling the responder node:

```python
# app/workflow.py
workflow.add_edge("maria", "responder")  # Make sure these exist
workflow.add_edge("carlos", "responder")
workflow.add_edge("sofia", "responder")
```

### 2. GHL Client Not Configured
```python
# Check if send_message is implemented
async def send_message(self, contact_id: str, message: str, type: str = "SMS"):
    """Send message via GHL API"""
    endpoint = f"conversations/messages"
    
    payload = {
        "type": type,
        "contactId": contact_id,
        "message": message
    }
    
    # Make sure we have auth headers
    headers = get_ghl_headers()  # Must include Bearer token
    
    response = await self._make_request("POST", endpoint, json=payload)
    return response
```

### 3. Webhook Response Format
The webhook might expect a specific response format:

```python
# Instead of internal state updates
return {
    "response_sent": True,
    "webhook_response": {
        "message": content,
        "status": "sent"
    }
}
```

## Testing the Fix

1. **Add debug logging**:
```python
logger.info(f"Responder state keys: {list(state.keys())}")
logger.info(f"Messages count: {len(state.get('messages', []))}")
logger.info(f"Contact ID: {state.get('contact_id')}")
```

2. **Test locally**:
```bash
# Run with debug logging
LOG_LEVEL=DEBUG python app.py
```

3. **Check GHL API logs**:
- Verify API calls are being made
- Check for authentication errors
- Look for rate limiting

## Emergency Hotfix

If messages need to be sent immediately:

```python
# Quick bypass - send directly from agent nodes
async def maria_node(state):
    # ... generate response
    
    # Send immediately (temporary fix)
    if message_to_send:
        ghl_client = GHLClient()
        await ghl_client.send_message(
            contact_id=state["contact_id"],
            message=message_to_send
        )
    
    return {"messages": messages}
```

## Expected Result After Fix

```
ðŸ“¤ RESPONDER NODE:
  - Message sent: Yes âœ…
  - Status: sent
```